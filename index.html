<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pengurus Skrip & Cerita PWA</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#3a5a40">

<style>
/* ==================== */
/* === Gaya (CSS) === */
/* ==================== */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f6fdf6;
    color: #333;
}
header {
    background-color: #3a5a40;   
    color: white;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
h1 { margin: 0; font-size: 1.8em; }
main { padding: 20px; }
.primary-btn { background-color: #588157; color: white; border: none; padding: 12px 20px; margin-bottom: 20px; border-radius: 8px; cursor: pointer; font-size: 1.1em; transition: 0.2s; }
.primary-btn:hover { background-color: #3a5a40; }
.story-item { background-color: white; border: 1px solid #ddd; padding: 15px; margin-bottom: 25px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
.episode-item { margin-left: 20px; padding: 10px; border-left: 3px solid #a3b18a; margin-top: 15px; position: relative; }
.scene-item { margin-left: 15px; padding: 10px; border: 1px dashed #c1d3c1; margin-top: 10px; background-color: #f0f7f0; border-radius: 5px; position: relative; }
.plot-area { margin-top: 8px; padding: 10px; background-color: #fff; border: 1px solid #c8d9c8; border-radius: 4px; }
.plot-area h5 { margin-top: 0; margin-bottom: 5px; color: #3a5a40; font-size: 0.9em; }
.plot-text { width: 100%; min-height: 50px; padding: 5px; border: 1px solid #eee; border-radius: 3px; box-sizing: border-box; resize: vertical; }
.delete-btn { position: absolute; top: 5px; right: 5px; background: #ff5c5c; color: white; border: none; padding: 4px 8px; border-radius: 50%; cursor: pointer; font-weight: bold; line-height: 1; font-size: 0.8em; z-index: 10; }
.delete-script-btn { position: static; background: #ff7878; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 10px; }
.character-script-item { list-style: none; padding: 10px 0; margin-left: -40px; border-bottom: 1px dotted #ccc; }
.script-row { display: flex; justify-content: space-between; align-items: center; background-color: #eaf4e5; padding: 8px; border-radius: 4px; margin-bottom: 5px; }
.read-status-message { margin-top: 5px; color: #1a7431; font-style: italic; font-size: 0.9em; display: none; padding-left: 10px; }
[contenteditable="true"]:focus { outline: 2px solid #84a98c; background-color: #fff9e6; }
.export-btn, .import-btn { background-color: #3a5a40; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; margin-right: 8px; }
.export-btn:hover, .import-btn:hover { opacity: 0.8; }
</style>
</head>
<body>

<header>
    <h1>‚úçÔ∏è Pengurus Skrip & Cerita PWA</h1>
</header>

<main id="app-container">

    <button id="add-story-btn" class="primary-btn">+ Tambah Cerita</button>
    <button id="export-json-btn" class="export-btn">üíæ Export JSON</button>
    <input type="file" id="import-json-file" class="import-btn" style="display:none" accept=".json">
    <button id="import-json-trigger" class="import-btn">üìÇ Import JSON</button>

    <div id="stories-list"></div>

</main>

<script>
// ==========================================
// PWA Story Manager JS
// ==========================================
const storiesList = document.getElementById('stories-list');
let storyCounter = 0, episodeCounter = 0, sceneCounter = 0, characterCounter = 0;

// --- Delete Helper
function attachDeleteListener(element, selector) {
    const deleteBtn = element.querySelector(selector);
    if(deleteBtn){
        deleteBtn.addEventListener('click', e => {
            if(confirm("Anda pasti ingin membuang item ini?")){
                e.target.closest(selector === '.delete-script-btn' ? '.character-script-item' : '.story-item, .episode-item, .scene-item').remove();
            }
        });
    }
}

// --- Checkbox 'Done'
function registerCheckboxListeners(){
    document.querySelectorAll('.read-done-checkbox').forEach(cb=>{
        if(cb.hasAttribute('data-listener-attached')) return;
        cb.setAttribute('data-listener-attached','true');
        cb.addEventListener('change', e=>{
            const item = e.target.closest('.character-script-item');
            const statusMsg = item.querySelector('.read-status-message');
            statusMsg.style.display = e.target.checked ? 'block' : 'none';
        });
    });
}

// --- Character/Script Item
function createCharacterScriptItem(storyId, episodeId, sceneId){
    characterCounter++;
    const itemId = `${storyId}-${episodeId}-${sceneId}-${characterCounter}`;
    const li = document.createElement('li');
    li.className = 'character-script-item';
    li.dataset.characterId = itemId;
    li.innerHTML = `
        <div class="script-row">
            <span contenteditable="true" class="character-name">Watak (?)</span>
            <div class="script-row-controls">
                <label>Siap Baca
                    <input type="checkbox" class="read-done-checkbox">
                </label>
                <button class="delete-btn delete-script-btn">X</button>
            </div>
        </div>
        <div class="script-content-area">
            <span contenteditable="true" class="script-name">Nama Skrip/Babak Ringkas (?)</span>
            <textarea class="script-text" placeholder="Ruang skrip di sini..."></textarea>
        </div>
        <p class="read-status-message">* Skrip ini telah dibaca</p>
    `;
    attachDeleteListener(li,'.delete-script-btn');
    return li;
}

// --- Scene Item
function createSceneItem(storyId, episodeId){
    sceneCounter++;
    const sceneId = `${episodeId}-${sceneCounter}`;
    const div = document.createElement('div');
    div.className = 'scene-item';
    div.dataset.sceneId = sceneId;
    div.innerHTML = `
        <button class="delete-btn delete-scene-btn">X</button>
        <div class="scene-header">
            <h4 contenteditable="true">Babak (?) : Nama Babak (Moment)</h4>
        </div>
        <div class="plot-area">
            <h5>Alur Cerita / Ringkasan Babak</h5>
            <textarea class="plot-text" placeholder="Tulis alur cerita atau ringkasan babak ini di sini..."></textarea>
        </div>
        <button class="add-character-btn" data-story-id="${storyId}" data-episode-id="${episodeId}" data-scene-id="${sceneId}">--- Tambah Watak</button>
        <ul class="characters-list"></ul>
    `;
    const charactersList = div.querySelector('.characters-list');
    charactersList.appendChild(createCharacterScriptItem(storyId, episodeId, sceneId));
    const addButton = div.querySelector('.add-character-btn');
    addButton.addEventListener('click', e=>{
        const list = div.querySelector('.characters-list');
        const sId = e.target.dataset.storyId;
        const eId = e.target.dataset.episodeId;
        const scId = e.target.dataset.sceneId;
        list.appendChild(createCharacterScriptItem(sId,eId,scId));
        registerCheckboxListeners();
    });
    attachDeleteListener(div,'.delete-scene-btn');
    return div;
}

// --- Episode Item
function createEpisodeItem(storyId){
    episodeCounter++;
    const episodeId = `${storyId}-${episodeCounter}`;
    const div = document.createElement('article');
    div.className = 'episode-item';
    div.dataset.episodeId = episodeId;
    div.innerHTML = `
        <button class="delete-btn delete-episode-btn">X</button>
        <div class="episode-header">
            <h3 contenteditable="true" class="episode-name">Episod (?)</h3>
        </div>
        <button class="add-btn add-scene-btn" data-story-id="${storyId}" data-episode-id="${episodeId}">[+] Tambah Babak</button>
        <div class="scenes-list"></div>
    `;
    const scenesList = div.querySelector('.scenes-list');
    const addSceneBtn = div.querySelector('.add-scene-btn');
    addSceneBtn.addEventListener('click', ()=>{
        scenesList.appendChild(createSceneItem(storyId, episodeId));
        registerCheckboxListeners();
    });
    scenesList.appendChild(createSceneItem(storyId, episodeId));
    attachDeleteListener(div,'.delete-episode-btn');
    return div;
}

// --- Story Item
function createStoryItem(){
    storyCounter++;
    const storyId = storyCounter;
    const section = document.createElement('section');
    section.className = 'story-item';
    section.dataset.storyId = storyId;
    section.innerHTML = `
        <button class="delete-btn delete-story-btn">X</button>
        <div class="story-header">
            <h2 contenteditable="true" class="story-title">Tajuk Cerita (?)</h2>
        </div>
        <button class="add-btn add-episode-btn">+ Tambah Episod</button>
        <div class="episodes-list"></div>
    `;
    const episodesList = section.querySelector('.episodes-list');
    const addEpisodeBtn = section.querySelector('.add-episode-btn');
    addEpisodeBtn.addEventListener('click', ()=>{
        episodesList.appendChild(createEpisodeItem(storyId));
        registerCheckboxListeners();
    });
    episodesList.appendChild(createEpisodeItem(storyId));
    storiesList.appendChild(section);
    registerCheckboxListeners();
    attachDeleteListener(section,'.delete-story-btn');
}

// --- Event Listeners Utama
document.getElementById('add-story-btn').addEventListener('click', createStoryItem);

// --- Export JSON
document.getElementById('export-json-btn').addEventListener('click', ()=>{
    const data = storiesList.innerHTML;
    const blob = new Blob([data], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'movie_export.html';
    a.click();
    URL.revokeObjectURL(a.href);
});

// --- Import JSON
document.getElementById('import-json-trigger').addEventListener('click', ()=>{
    document.getElementById('import-json-file').click();
});
document.getElementById('import-json-file').addEventListener('change', e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = evt => { storiesList.innerHTML = evt.target.result; registerCheckboxListeners(); };
    reader.readAsText(file);
});
document.addEventListener('DOMContentLoaded', createStoryItem);
</script>

<script>
// --- Service Worker PWA
if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('./sw.js').then(()=>console.log('SW registered')).catch(console.error);
    });
}
</script>

</body>
</html>